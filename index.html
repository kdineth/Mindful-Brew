<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <!-- PWA Settings -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Mindful Brew">
    <meta name="theme-color" content="#0A2218">
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="fav.svg">
    <link rel="apple-touch-icon" href="fav.svg">

    <title>Mindful Brew</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Playfair+Display:ital,wght@0,400;0,600;0,700;1,400&display=swap" rel="stylesheet">

    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        forest: '#0A2218',
                        forestLight: '#1A3C2B',
                        cream: '#EBECE5',
                        gold: '#C8AD7F',
                        goldDim: '#8C7A59',
                        active: '#4ADE80',
                    },
                    fontFamily: {
                        playfair: ['"Playfair Display"', 'serif'],
                        inter: ['"Inter"', 'sans-serif'],
                    },
                    animation: {
                        'slide-up': 'slideUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                        'scale-in': 'scaleIn 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                        'fade-in': 'fadeIn 0.5s ease-out forwards',
                        'pulse-gold': 'pulseGold 2s infinite',
                    },
                    keyframes: {
                        slideUp: {
                            '0%': { opacity: '0', transform: 'translateY(20px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        },
                        scaleIn: {
                            '0%': { opacity: '0', transform: 'scale(0.9)' },
                            '100%': { opacity: '1', transform: 'scale(1)' },
                        },
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        pulseGold: {
                            '0%, 100%': { opacity: '1' },
                            '50%': { opacity: '0.5' },
                        }
                    },
                    screens: {
                        'xs': '375px',
                    }
                }
            }
        }
    </script>

    <!-- Alpine.js -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

    <style>
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .batik-bg {
            background-color: #0A2218;
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23C8AD7F' fill-opacity='0.02'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.02);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(200, 173, 127, 0.1); 
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
            border-radius: 1rem;
        }

        .kandyan-corner {
            position: absolute;
            width: 10px;
            height: 10px;
            border-top: 1px solid rgba(200, 173, 127, 0.5);
            border-right: 1px solid rgba(200, 173, 127, 0.5);
            top: 10px;
            right: 10px;
        }
        
        .progress-ring__circle {
            transition: stroke-dashoffset 1s linear;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
        }

        /* Safe Area Utilities with defaults for non-notched phones */
        .pt-safe { padding-top: max(1.5rem, env(safe-area-inset-top)); }
        .pb-safe { padding-bottom: max(1.5rem, env(safe-area-inset-bottom)); }
        
        /* Smooth scrolling for iOS */
        .smooth-scroll {
            -webkit-overflow-scrolling: touch;
        }

        body { 
            overscroll-behavior-y: none; 
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            -webkit-user-select: none;
            -webkit-text-size-adjust: 100%;
        }

        [x-cloak] { display: none !important; }
    </style>
</head>
<body class="batik-bg text-cream font-inter antialiased h-[100dvh] w-screen flex justify-center items-center selection:bg-gold selection:text-forest overflow-hidden">

    <!-- Decorative Background Bloom -->
    <div class="fixed top-[-20%] left-[-10%] w-[120%] h-[60%] rounded-full bg-forestLight blur-[120px] opacity-20 pointer-events-none z-0"></div>
    <div class="fixed bottom-[-10%] right-[-10%] w-[80%] h-[50%] rounded-full bg-goldDim blur-[140px] opacity-10 pointer-events-none z-0"></div>

    <!-- Main Container -->
    <main id="app-container"
          x-data="teaApp()" 
          x-init="initApp()"
          class="w-full h-full sm:h-[90dvh] sm:max-w-[400px] sm:rounded-[32px] relative flex flex-col z-10 bg-[#0A2218]/50 sm:bg-[#0A2218]/80 backdrop-blur-sm sm:border sm:border-white/5 sm:shadow-2xl overflow-hidden transition-all duration-500">
        
        <!-- === VIEW: LOGIN === -->
        <section x-show="view === 'login'" 
                 x-transition:leave="transition ease-in duration-500"
                 x-transition:leave-start="opacity-100 scale-100"
                 x-transition:leave-end="opacity-0 scale-95"
                 class="absolute inset-0 z-50 flex flex-col items-center justify-center px-8 bg-forest">
            
            <div class="text-center mb-16 animate-fade-in">
                <h1 class="font-playfair text-4xl font-bold tracking-widest text-gold mb-3">MINDFUL<br>BREW</h1>
                <div class="w-12 h-px bg-gold/30 mx-auto mb-3"></div>
                <p class="text-xs text-white/40 font-playfair italic tracking-wider">Ancient wisdom. Modern science.</p>
            </div>

            <!-- Google Sign In Button -->
            <button @click="login()" 
                    class="w-full max-w-[280px] bg-white/95 text-forest font-medium flex items-center justify-center gap-3 py-3.5 rounded-xl shadow-lg hover:bg-white transition-all active:scale-95 group">
                <svg class="w-5 h-5" viewBox="0 0 24 24">
                    <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/>
                    <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/>
                    <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/>
                    <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/>
                </svg>
                <span class="tracking-wide text-sm">Sign in with Google</span>
            </button>
            
            <p class="absolute bottom-10 text-[10px] text-white/10 uppercase tracking-[0.3em]">Experience Serenity</p>
        </section>

        <!-- === MAIN APP === -->
        <div x-show="view !== 'login'" class="flex-1 flex flex-col h-full overflow-hidden">
            
            <header class="pt-safe pb-2 px-6 flex justify-between items-center z-20 shrink-0">
                <div class="flex items-center gap-2 opacity-80">
                    <div>
                        <h1 class="font-playfair text-base font-bold tracking-widest text-gold">MINDFUL BREW</h1>
                    </div>
                </div>
            </header>

            <div class="relative flex-1 w-full overflow-hidden">
                
                <!-- === TAB: HOME === -->
                <section x-show="activeTab === 'home' && view === 'home'" 
                         class="absolute inset-0 px-6 flex flex-col pb-32 overflow-y-auto no-scrollbar pt-2 smooth-scroll">
                    
                    <div x-show="canInstall" x-transition class="mb-6 animate-fade-in">
                        <button @click="installApp()" class="w-full p-4 rounded-xl bg-gradient-to-r from-gold/10 to-gold/5 border border-gold/20 flex items-center justify-between group active:scale-[0.98] transition-all">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-lg bg-gold/20 flex items-center justify-center text-gold">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                                </div>
                                <div class="text-left">
                                    <p class="text-xs font-bold text-gold uppercase tracking-wider">Get the App</p>
                                    <p class="text-[10px] text-white/60">Add to Home Screen for full experience</p>
                                </div>
                            </div>
                            <div class="text-white/40 group-hover:text-gold transition-colors">&rarr;</div>
                        </button>
                    </div>

                    <h2 class="font-playfair text-3xl mb-2 leading-tight animate-slide-up text-cream">
                        How are you <br>
                        <span class="text-gold italic">feeling today?</span>
                    </h2>
                    <p class="text-xs text-white/40 mb-6 max-w-[260px] leading-relaxed animate-slide-up font-light" style="animation-delay: 100ms">
                        Select your state for a Kandyan-inspired remedy.
                    </p>

                    <button @click="startQuickCalm()" 
                            class="mb-6 w-full glass-card p-4 flex items-center gap-4 animate-slide-up group hover:bg-white/5 transition-colors active:scale-[0.98]" style="animation-delay: 150ms">
                        <div class="h-10 w-10 rounded-full bg-white/10 flex items-center justify-center text-xl group-hover:scale-110 transition-transform">üßò</div>
                        <div class="text-left">
                            <h3 class="font-playfair text-white text-base">Quick Calm</h3>
                            <p class="text-[10px] text-white/50 uppercase tracking-wider">1 Minute Breathing ‚Ä¢ No Tea Required</p>
                        </div>
                        <div class="ml-auto text-gold opacity-50 group-hover:opacity-100 group-hover:translate-x-1 transition-all">&rarr;</div>
                    </button>

                    <div class="grid grid-cols-2 gap-3">
                        <template x-for="(item, index) in moods" :key="item.id">
                            <button @click="selectTea(item)"
                                    class="glass-card group relative h-36 p-5 text-left transition-all duration-300 hover:bg-white/5 hover:border-gold/30 hover:shadow-[0_0_25px_rgba(200,173,127,0.1)] active:scale-[0.98] active:bg-white/10 flex flex-col justify-between overflow-hidden"
                                    :style="`animation-delay: ${index * 100 + 200}ms`"
                                    :class="'animate-slide-up'">
                                <div class="kandyan-corner opacity-30 group-hover:opacity-100 transition-opacity duration-500"></div>
                                <div class="absolute top-0 right-0 p-4 opacity-40 group-hover:opacity-100 transition-all duration-500 transform group-hover:scale-110 group-hover:-rotate-6 origin-top-right grayscale group-hover:grayscale-0">
                                    <span class="text-3xl filter drop-shadow-md" x-text="item.icon"></span>
                                </div>
                                <div class="mt-auto relative z-10">
                                    <span class="block text-lg font-playfair font-medium text-white/90 group-hover:text-gold transition-colors duration-300" x-text="item.label"></span>
                                    <span class="text-[10px] text-white/30 uppercase tracking-wider group-hover:text-gold/70 transition-colors duration-300 group-hover:translate-x-1 inline-block transform">Select &rarr;</span>
                                </div>
                            </button>
                        </template>
                    </div>
                </section>

                <!-- === VIEW: BREW RESULT / TIMER === -->
                <section x-show="view === 'result'" 
                         x-cloak
                         class="absolute inset-0 flex flex-col h-full bg-forest/95 backdrop-blur-xl z-30">
                    
                    <div class="px-6 pt-safe pb-4 flex justify-between items-center relative z-50 shrink-0">
                        <button @click="reset()" class="group flex items-center gap-2 text-xs uppercase tracking-widest text-white/40 hover:text-gold transition-colors p-2 -ml-2">
                            <span class="transform group-hover:-translate-x-1 transition-transform">&larr;</span> Back
                        </button>
                        <!-- Share Button -->
                        <button @click="shareExperience()" 
                                class="group flex items-center gap-2 text-xs uppercase tracking-widest text-white/40 hover:text-gold transition-colors p-2 -mr-2">
                            <span>Share Experience</span>
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" /></svg>
                        </button>
                    </div>

                    <div class="flex-1 overflow-y-auto no-scrollbar px-6 pb-32 smooth-scroll" id="brew-content">
                        <div class="text-center mb-6 animate-slide-up">
                            <div class="inline-flex items-center gap-2 px-4 py-1.5 rounded-full border border-gold/10 bg-gold/5 text-[10px] uppercase tracking-[0.2em] text-gold mb-4 shadow-[0_0_15px_rgba(200,173,127,0.1)]">
                                <span x-text="selectedMood?.label || 'Quick Calm'"></span> Remedy
                            </div>
                            <h2 class="font-playfair text-3xl font-bold text-cream mb-2 leading-tight" x-text="selectedTea?.name || 'Deep Breathing'"></h2>
                            <p class="font-playfair italic text-white/50 text-lg font-light mb-4" x-text="selectedTea?.benefit || 'Restores Balance'"></p>
                            
                            <!-- AI Wisdom Feature -->
                            <div class="mb-4">
                                <button x-show="!zenWisdom" 
                                        @click="getZenWisdom()"
                                        :disabled="aiLoading"
                                        class="mx-auto flex items-center gap-2 px-4 py-2 rounded-full bg-white/5 hover:bg-white/10 border border-gold/20 transition-all active:scale-95 group">
                                    <span class="text-lg" :class="aiLoading ? 'animate-spin' : ''">‚ú®</span>
                                    <span class="text-[10px] uppercase tracking-widest text-gold group-hover:text-white" x-text="aiLoading ? 'Consulting the Sage...' : 'Reveal Daily Wisdom'"></span>
                                </button>

                                <div x-show="zenWisdom" 
                                     x-transition
                                     class="max-w-[300px] mx-auto p-4 rounded-xl border border-gold/30 bg-gold/5 relative mt-2">
                                    <div class="absolute -top-2 left-1/2 -translate-x-1/2 bg-[#0d2a1e] px-2 text-gold text-xs">‚ú®</div>
                                    <p class="font-playfair italic text-white/90 text-sm leading-relaxed" x-text="zenWisdom"></p>
                                </div>
                            </div>

                            <!-- Expandable Insights Section -->
                            <div class="mx-auto max-w-[320px]">
                                <button @click="showDetails = !showDetails" class="flex items-center justify-center gap-2 mx-auto text-[10px] text-gold/80 uppercase tracking-widest hover:text-gold transition-colors py-2">
                                    <span>Brewing Insights</span>
                                    <svg class="w-3 h-3 transition-transform duration-300" :class="showDetails ? 'rotate-180' : ''" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                                </button>

                                <div x-show="showDetails" 
                                     x-transition:enter="transition ease-out duration-200"
                                     x-transition:enter-start="opacity-0 -translate-y-2 scale-95"
                                     x-transition:enter-end="opacity-100 translate-y-0 scale-100"
                                     class="text-left glass-card p-4 mt-2">
                                    <div class="mb-3 border-b border-white/5 pb-2">
                                        <h4 class="text-gold text-[10px] font-bold uppercase mb-1 flex items-center gap-1">
                                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.384-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z" /></svg>
                                            Science
                                        </h4>
                                        <p class="text-[11px] text-white/70 leading-relaxed font-light" x-text="selectedTea?.science"></p>
                                    </div>
                                    <div>
                                        <h4 class="text-gold text-[10px] font-bold uppercase mb-1 flex items-center gap-1">
                                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>
                                            Preparation Tip
                                        </h4>
                                        <p class="text-[11px] text-white/70 leading-relaxed font-light" x-text="selectedTea?.tips"></p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Timer with Dynamic Breathing Animation -->
                        <div class="relative flex flex-col items-center justify-center py-4 mb-10 min-h-[300px] animate-scale-in">
                            
                            <!-- Dynamic Breathing Halo -->
                            <div class="absolute w-64 h-64 rounded-full bg-gold/20 blur-3xl transition-all ease-in-out"
                                 :class="{
                                    'scale-50 opacity-0 duration-500': !timerRunning,
                                    'scale-125 opacity-50 duration-[4000ms]': timerRunning && breathState === 'inhale',
                                    'scale-125 opacity-50 duration-500': timerRunning && breathState === 'hold',
                                    'scale-75 opacity-20 duration-[5000ms]': timerRunning && breathState === 'exhale'
                                 }">
                            </div>

                            <!-- SVG Ring -->
                            <div class="relative w-64 h-64">
                                <svg class="w-full h-full" viewBox="0 0 100 100">
                                    <circle cx="50" cy="50" r="45" fill="none" stroke="rgba(255,255,255,0.03)" stroke-width="1" />
                                    <circle class="progress-ring__circle" cx="50" cy="50" r="45" fill="none" stroke="#C8AD7F" stroke-width="1.5" stroke-linecap="round" :stroke-dasharray="circumference" :stroke-dashoffset="strokeDashoffset" />
                                </svg>
                                <div class="absolute inset-0 flex flex-col items-center justify-center text-center">
                                    <div class="font-playfair text-5xl font-bold text-cream tabular-nums tracking-tighter" x-text="formattedTime"></div>
                                    <div class="text-[10px] uppercase tracking-[0.2em] mt-3 font-medium transition-colors duration-500" 
                                         :class="timerRunning ? (breathState === 'hold' ? 'text-white' : 'text-gold') : 'text-white/20'" 
                                         x-text="timerRunning ? breathPhase : 'READY'"></div>
                                </div>
                            </div>

                            <!-- Controls -->
                            <div class="flex items-center gap-6 mt-10 z-10 relative">
                                <!-- Reset -->
                                <button @click="resetTimer()" class="p-3 rounded-full text-white/20 hover:bg-white/5 hover:text-white transition-all disabled:opacity-0 disabled:pointer-events-none" :disabled="timer === initialTime">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74-2.74L3 12"/></svg>
                                </button>
                                
                                <!-- Play/Pause -->
                                <button @click="toggleTimer()" 
                                        class="h-16 w-16 rounded-full bg-gold/90 text-forest flex items-center justify-center shadow-[0_0_30px_rgba(200,173,127,0.2)] hover:bg-[#D4BC8E] hover:scale-105 active:scale-95 transition-all duration-500">
                                    <svg x-show="!timerRunning" class="w-6 h-6 ml-1" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                                    <svg x-show="timerRunning" class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
                                </button>

                                <!-- Controls Right Cluster -->
                                <div class="flex flex-col gap-2">
                                    <!-- Haptic Toggle -->
                                    <button @click="toggleHaptics()" 
                                            class="p-2.5 rounded-full transition-all duration-300 relative group"
                                            :class="hapticsEnabled ? 'text-active bg-active/10' : 'text-white/20 hover:text-white hover:bg-white/5'">
                                        <svg x-show="hapticsEnabled" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M22 12a1 1 0 0 1-10 0 1 1 0 0 1 10 0Z"/><path d="M6 12a1 1 0 0 1-10 0 1 1 0 0 1 10 0Z"/><path d="M12 2a1 1 0 0 1 0 10 1 1 0 0 1 0-10Z"/><path d="M12 22a1 1 0 0 1 0-10 1 1 0 0 1 0 10Z"/></svg>
                                        <svg x-show="!hapticsEnabled" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="6" y="2" width="12" height="20" rx="2" ry="2"/><line x1="12" y1="18" x2="12.01" y2="18"/></svg>
                                    </button>

                                    <!-- Ambience Toggle -->
                                    <button @click="toggleAmbience()" 
                                            class="p-2.5 rounded-full transition-all duration-300 relative group"
                                            :class="audioState !== 'off' ? 'text-gold bg-gold/10' : 'text-white/20 hover:text-white hover:bg-white/5'">
                                        <svg x-show="audioState === 'off'" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M11 5L6 9H2v6h4l5 4V5z"/><line x1="23" y1="9" x2="17" y2="15"/><line x1="17" y1="9" x2="23" y2="15"/></svg>
                                        <svg x-show="audioState === 'rain'" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M17.5 19c0-1.7-1.3-3-3-3h-11C1.7 16 .2 14.5.2 12.8c0-1.7 1.5-3 3.2-3 .4-2.1 2.3-4 5.1-4 2.1 0 4 1.2 5 3 1.9-.3 3.6.8 4 2.7"/><path d="M10 20v2"/><path d="M6 20v2"/><path d="M14 20v2"/></svg>
                                        <svg x-show="audioState === 'forest'" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M8 10l4-6 4 6"/><path d="M4 22l6-12"/><path d="M20 22l-6-12"/><path d="M12 22v-8"/></svg>
                                    </button>
                                </div>
                            </div>

                             <!-- Log Journal Button -->
                            <button @click="openJournalModal({ fromSession: true })" 
                                    class="mt-8 flex items-center gap-2 px-5 py-2.5 rounded-xl bg-white/5 border border-white/10 text-white/60 text-xs uppercase tracking-widest hover:bg-white/10 hover:text-gold hover:border-gold/30 transition-all">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                                Log Experience
                            </button>
                        </div>
                    </div>
                </section>

                <!-- === TAB: SCIENCE === -->
                <section x-show="activeTab === 'science'" 
                         x-cloak
                         class="absolute inset-0 px-6 pb-32 overflow-y-auto no-scrollbar pt-safe animate-fade-in smooth-scroll">
                    
                    <h2 class="font-playfair text-3xl mb-6 text-cream leading-tight">
                        The Science of <br> <span class="text-gold italic">Mindful Brewing</span>
                    </h2>

                    <!-- Color Psychology Article -->
                    <div class="glass-card p-6 mb-6">
                        <div class="kandyan-corner"></div>
                        <h3 class="font-playfair text-lg text-gold mb-2">Color Psychology</h3>
                        <p class="text-sm text-white/60 leading-relaxed font-light mb-4">
                            The visual environment directly impacts the autonomic nervous system.
                        </p>
                        <div class="space-y-3">
                            <div class="flex items-center gap-3">
                                <div class="w-6 h-6 rounded-full bg-[#0A2218] border border-white/10"></div>
                                <div>
                                    <span class="text-xs text-white block">Deep Forest</span>
                                    <span class="text-[10px] text-white/40">Lowers heart rate & grounds the senses.</span>
                                </div>
                            </div>
                            <div class="flex items-center gap-3">
                                <div class="w-6 h-6 rounded-full bg-[#C8AD7F]"></div>
                                <div>
                                    <span class="text-xs text-white block">Champagne Gold</span>
                                    <span class="text-[10px] text-white/40">Evokes warmth without blue-light strain.</span>
                                </div>
                            </div>
                            <div class="flex items-center gap-3">
                                <div class="w-6 h-6 rounded-full bg-[#EBECE5]"></div>
                                <div>
                                    <span class="text-xs text-white block">Sage Cream</span>
                                    <span class="text-[10px] text-white/40">Reduces contrast fatigue for tired eyes.</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Enhanced Science Content -->
                    <div class="glass-card p-6 mb-6">
                        <div class="kandyan-corner"></div>
                        <h3 class="font-playfair text-lg text-gold mb-2">Alpha Brain Waves</h3>
                        <p class="text-sm text-white/60 leading-relaxed font-light mb-4">
                            L-Theanine, an amino acid found abundantly in tea leaves, has been clinically shown to increase alpha brain wave activity. This state creates "relaxed alertness"‚Äîa unique condition where the mind is calm yet sharp, unlike the jittery energy of coffee or the drowsiness of sedatives.
                        </p>
                    </div>

                    <div class="glass-card p-6 mb-6">
                        <div class="kandyan-corner"></div>
                        <h3 class="font-playfair text-lg text-gold mb-2">The Chemistry of Calm</h3>
                        <p class="text-sm text-white/60 leading-relaxed font-light mb-4">
                            Polyphenols, specifically catechins in green tea and theaflavins in black tea, act as powerful antioxidants. They reduce oxidative stress in the brain, which is directly linked to anxiety and mood regulation.
                        </p>
                    </div>

                    <div class="glass-card p-6 mb-6">
                        <div class="kandyan-corner"></div>
                        <h3 class="font-playfair text-lg text-gold mb-2">Olfactory Healing</h3>
                        <p class="text-sm text-white/60 leading-relaxed font-light">
                            The aroma of tea triggers the olfactory bulb, which has a direct pathway to the amygdala‚Äîthe emotional center of the brain. Inhaling the steam of peppermint or chamomile can instantly signal the parasympathetic nervous system to initiate a "rest and digest" state.
                        </p>
                    </div>
                </section>

                <!-- === TAB: HISTORY === -->
                <section x-show="activeTab === 'history'" 
                         x-cloak
                         class="absolute inset-0 px-6 pb-32 overflow-y-auto no-scrollbar pt-safe animate-fade-in smooth-scroll">
                    
                    <h2 class="font-playfair text-3xl mb-6 text-cream leading-tight">
                        The Legacy <br> <span class="text-gold italic">of the Leaf</span>
                    </h2>

                    <div class="relative pl-4 border-l border-gold/20 space-y-8 my-4">
                        
                        <!-- Timeline Item 1 -->
                        <div class="relative">
                            <div class="absolute -left-[21px] top-1 h-3 w-3 rounded-full bg-gold border-2 border-[#0A2218]"></div>
                            <h3 class="text-gold font-playfair text-lg">2737 BC ‚Ä¢ The Beginning</h3>
                            <p class="text-sm text-white/60 mt-1 leading-relaxed font-light">
                                Legend holds that Emperor Shen Nong was boiling water when wild tea leaves drifted into his pot. Entranced by the aroma, he drank the brew, describing it as "turning the body into a clear crystal," marking the discovery of tea in China.
                            </p>
                        </div>

                        <!-- Timeline Item 2 -->
                        <div class="relative">
                            <div class="absolute -left-[21px] top-1 h-3 w-3 rounded-full bg-gold/50 border-2 border-[#0A2218]"></div>
                            <h3 class="text-gold font-playfair text-lg">1191 ‚Ä¢ The Zen Connection</h3>
                            <p class="text-sm text-white/60 mt-1 leading-relaxed font-light">
                                The monk Eisai brought tea seeds to Japan, intertwining tea with Zen Buddhism. It became a tool for monks to stay awake during long meditations, eventually evolving into the intricate Japanese Tea Ceremony.
                            </p>
                        </div>

                         <!-- Timeline Item 3 -->
                         <div class="relative">
                            <div class="absolute -left-[21px] top-1 h-3 w-3 rounded-full bg-gold/50 border-2 border-[#0A2218]"></div>
                            <h3 class="text-gold font-playfair text-lg">1867 ‚Ä¢ The Birth of Ceylon Tea</h3>
                            <p class="text-sm text-white/60 mt-1 leading-relaxed font-light">
                                After a coffee blight devastated Sri Lanka, Scotsman James Taylor planted the first tea field on the Loolecondera estate in Kandy. The unique microclimate of the highlands produced a robust, golden brew that would soon captivate the world.
                            </p>
                        </div>

                        <!-- Timeline Item 4 -->
                        <div class="relative">
                            <div class="absolute -left-[21px] top-1 h-3 w-3 rounded-full bg-gold/50 border-2 border-[#0A2218]"></div>
                            <h3 class="text-gold font-playfair text-lg">Modern Day ‚Ä¢ Mindful Brewing</h3>
                            <p class="text-sm text-white/60 mt-1 leading-relaxed font-light">
                                Today, we return to tea not just for caffeine, but for connection. In a digital age, the analog ritual of heating water, steeping leaves, and waiting offers a rare moment of stillness.
                            </p>
                        </div>

                    </div>
                </section>

                <!-- === TAB: JOURNAL === -->
                <section x-show="activeTab === 'journal'" 
                         x-cloak
                         class="absolute inset-0 px-6 pb-32 overflow-y-auto no-scrollbar pt-safe animate-fade-in smooth-scroll">
                    
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="font-playfair text-3xl text-cream leading-tight">
                            My Brew <br> <span class="text-gold italic">Journal</span>
                        </h2>
                        <button @click="openJournalModal()" class="w-10 h-10 rounded-full bg-gold/10 border border-gold/20 flex items-center justify-center text-gold hover:bg-gold/20 active:scale-95 transition-all">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                        </button>
                    </div>

                    <!-- Empty State -->
                    <div x-show="journalEntries.length === 0" class="flex flex-col items-center justify-center h-64 text-center opacity-50">
                        <div class="text-4xl mb-4 grayscale">üìú</div>
                        <p class="text-sm text-white font-playfair italic">Your journey begins with a single sip.</p>
                        <p class="text-xs text-white/40 mt-2">Log your first brew to start tracking.</p>
                    </div>

                    <!-- Entries List -->
                    <div class="space-y-4">
                        <template x-for="entry in journalEntries" :key="entry.id">
                            <div class="glass-card p-4 relative group hover:bg-white/5 transition-colors">
                                <button @click="deleteJournalEntry(entry.id)" class="absolute top-3 right-3 text-white/20 hover:text-red-400 p-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                </button>
                                
                                <div class="flex items-start justify-between mb-2 pr-8">
                                    <div>
                                        <span class="text-[10px] text-white/40 uppercase tracking-widest block mb-1" x-text="formatDate(entry.date)"></span>
                                        <h3 class="text-gold font-playfair text-lg" x-text="entry.tea"></h3>
                                    </div>
                                    <div class="text-2xl" x-text="getMoodIcon(entry.mood)"></div>
                                </div>
                                
                                <div class="flex gap-1 text-gold/80 mb-3 text-xs">
                                    <template x-for="i in 5">
                                        <span x-text="i <= entry.rating ? '‚òÖ' : '‚òÜ'"></span>
                                    </template>
                                </div>

                                <p x-show="entry.notes" class="text-sm text-white/70 font-light leading-relaxed border-t border-white/5 pt-3 mt-1" x-text="entry.notes"></p>
                            </div>
                        </template>
                    </div>
                </section>

            </div>

            <!-- Bottom Navigation -->
            <nav x-show="view !== 'result'" class="w-full bg-forest/90 backdrop-blur-md border-t border-white/5 flex items-center justify-around z-40 py-3 pb-safe shrink-0">
                <button @click="activeTab = 'home'" class="flex flex-col items-center gap-1 p-2 w-full transition-colors duration-300" :class="activeTab === 'home' ? 'text-gold' : 'text-white/20 hover:text-white/40'">
                    <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
                    </svg>
                    <span class="text-[10px] uppercase tracking-widest font-medium">Brew</span>
                </button>
                <button @click="activeTab = 'journal'" class="flex flex-col items-center gap-1 p-2 w-full transition-colors duration-300" :class="activeTab === 'journal' ? 'text-gold' : 'text-white/20 hover:text-white/40'">
                     <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path></svg>
                    <span class="text-[10px] uppercase tracking-widest font-medium">Journal</span>
                </button>
                 <button @click="activeTab = 'science'" class="flex flex-col items-center gap-1 p-2 w-full transition-colors duration-300" :class="activeTab === 'science' ? 'text-gold' : 'text-white/20 hover:text-white/40'">
                    <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.384-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z" />
                    </svg>
                    <span class="text-[10px] uppercase tracking-widest font-medium">Science</span>
                </button>
                <button @click="activeTab = 'history'" class="flex flex-col items-center gap-1 p-2 w-full transition-colors duration-300" :class="activeTab === 'history' ? 'text-gold' : 'text-white/20 hover:text-white/40'">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                    <span class="text-[10px] uppercase tracking-widest font-medium">History</span>
                </button>
            </nav>

             <!-- === JOURNAL MODAL === -->
             <div x-show="showJournalModal" 
                  x-cloak
                  class="absolute inset-0 z-[60] flex items-center justify-center p-6 bg-forest/90 backdrop-blur-md"
                  x-transition:enter="transition ease-out duration-300"
                  x-transition:enter-start="opacity-0 scale-95"
                  x-transition:enter-end="opacity-100 scale-100"
                  x-transition:leave="transition ease-in duration-200"
                  x-transition:leave-start="opacity-100 scale-100"
                  x-transition:leave-end="opacity-0 scale-95">
                 
                 <div class="glass-card w-full max-w-sm p-6 relative">
                     <button @click="showJournalModal = false" class="absolute top-4 right-4 text-white/40 hover:text-white">‚úï</button>
                     
                     <h3 class="font-playfair text-2xl text-gold mb-6 text-center">Log Moment</h3>
                     
                     <div class="space-y-4">
                         <!-- Tea Selection -->
                         <div>
                             <label class="block text-[10px] uppercase tracking-widest text-white/40 mb-1">Tea</label>
                             <select x-model="journalForm.tea" class="w-full bg-white/5 border border-white/10 rounded-lg px-3 py-2 text-white text-base focus:border-gold outline-none">
                                 <template x-for="t in Object.values(teas)" :key="t.name">
                                     <option x-text="t.name" :value="t.name"></option>
                                 </template>
                                 <option value="Other">Other</option>
                             </select>
                         </div>

                         <!-- Mood Selection -->
                         <div>
                             <label class="block text-[10px] uppercase tracking-widest text-white/40 mb-1">Mood</label>
                             <select x-model="journalForm.mood" class="w-full bg-white/5 border border-white/10 rounded-lg px-3 py-2 text-white text-base focus:border-gold outline-none">
                                 <template x-for="m in moods" :key="m.id">
                                     <option :value="m.id" x-text="m.label"></option>
                                 </template>
                             </select>
                         </div>

                         <!-- Rating -->
                         <div>
                             <label class="block text-[10px] uppercase tracking-widest text-white/40 mb-2">Rating</label>
                             <div class="flex gap-2 justify-center">
                                 <template x-for="i in 5">
                                     <button @click="journalForm.rating = i" 
                                             class="text-2xl transition-transform hover:scale-110"
                                             :class="i <= journalForm.rating ? 'text-gold' : 'text-white/20'">
                                         ‚òÖ
                                     </button>
                                 </template>
                             </div>
                         </div>

                         <!-- Notes -->
                         <div>
                             <label class="block text-[10px] uppercase tracking-widest text-white/40 mb-1">Notes</label>
                             <textarea x-model="journalForm.notes" 
                                       rows="3"
                                       class="w-full bg-white/5 border border-white/10 rounded-lg px-3 py-2 text-white text-base focus:border-gold outline-none placeholder-white/20"
                                       placeholder="How did it feel?"></textarea>
                         </div>

                         <button @click="saveJournalEntry()" class="w-full bg-gold text-forest font-bold py-3 rounded-xl mt-2 active:scale-95 transition-transform">
                             Save Entry
                         </button>
                     </div>
                 </div>
             </div>
        </div>
    </main>

    <!-- App Logic -->
    <script>
        function teaApp() {
            return {
                view: 'login',
                activeTab: 'home',
                installPrompt: null,
                canInstall: false,
                hapticsEnabled: false,
                showDetails: false,
                
                // AI State
                aiLoading: false,
                zenWisdom: '',
                apiKey: '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',

                // Audio State
                audioState: 'off', // off, rain, forest
                audioPlayer: null,
                audioTracks: {
                    rain: 'https://soundbible.com/mp3/Rain_Background-Mike_Koenig-168138251.mp3',
                    forest: 'https://soundbible.com/mp3/Forest_Ambience-Mike_Koenig-129668478.mp3'
                },
                
                // Share State
                sharing: false,

                // Journal State
                showJournalModal: false,
                journalEntries: [],
                journalForm: {
                    tea: '',
                    mood: '',
                    rating: 5,
                    notes: ''
                },
                
                // Haptic Fallback State
                hapticCtx: null,

                user: null,
                isIOS: /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream,
                isStandalone: window.matchMedia('(display-mode: standalone)').matches || (window.navigator.standalone === true),

                moods: [
                    { id: 'stressed', label: 'Stressed', icon: 'üåø' },
                    { id: 'foggy', label: 'Foggy Focus', icon: '‚òÅÔ∏è' },
                    { id: 'tired', label: 'Low Energy', icon: '‚ö°' },
                    { id: 'bloated', label: 'Bloated', icon: 'üéà' },
                    { id: 'sleepless', label: 'Sleepless', icon: 'üåô' }
                ],
                teas: {
                    stressed: { 
                        name: "Chamomile Flowers", 
                        benefit: "Calming & Cortisol Reduction", 
                        duration: 180,
                        science: "Chamomile contains apigenin, an antioxidant that binds to specific receptors in your brain that may decrease anxiety and initiate sleep.",
                        tips: "Steep covered for 5 minutes to retain volatile oils. Best consumed 45 minutes before bed."
                    },
                    foggy: { 
                        name: "Ceylon Green Tea", 
                        benefit: "Sustained Alpha Waves", 
                        duration: 180,
                        science: "The combination of L-theanine and caffeine improves brain function. L-theanine increases alpha waves, inducing relaxation while caffeine maintains alertness.",
                        tips: "Use water around 175¬∞F (80¬∞C) to avoid bitterness. Don't over-steep; 2-3 minutes is ideal."
                    },
                    tired: { 
                        name: "Premium Ceylon Black", 
                        benefit: "Robust Energy Lift", 
                        duration: 300,
                        science: "Black tea contains theaflavins which support cardiovascular health. The caffeine provides a sustained energy release unlike the crash of sugar.",
                        tips: "Requires boiling water (212¬∞F/100¬∞C) to fully extract flavonoids. Add a splash of milk if the tannins are too astringent."
                    },
                    bloated: { 
                        name: "Peppermint & Toffee", 
                        benefit: "Digestive Aid", 
                        duration: 180,
                        science: "Menthol in peppermint has antispasmodic effects on the digestive muscles, improving gas flow and reducing abdominal pain.",
                        tips: "Crush fresh leaves if using, or use high-grade dried leaves. Steep for 5-7 minutes."
                    },
                    sleepless: { 
                        name: "Pure Peppermint", 
                        benefit: "Deep Muscle Relaxation", 
                        duration: 300,
                        science: "Free of caffeine and containing muscle relaxants, peppermint lowers body temperature slightly, signaling the body it is time to sleep.",
                        tips: "Drink warm, not hot. Inhale the steam deeply before sipping to activate olfactory pathways."
                    }
                },
                selectedMood: null,
                selectedTea: null,
                
                timer: 0, 
                initialTime: 0,
                timerRunning: false,
                interval: null,
                circumference: 2 * Math.PI * 45,
                breathPhase: 'Inhale', 
                breathState: 'ready', // ready, inhale, hold, exhale
                cycleCounter: 0,

                initApp() {
                    this.initPWA();
                    // Preload audio
                    this.audioPlayer = new Audio();
                    this.audioPlayer.loop = true;
                    // Load Journal
                    const saved = localStorage.getItem('mindfulJournal');
                    if (saved) {
                        this.journalEntries = JSON.parse(saved);
                    }
                },

                // ... [PWA and Login methods remain same] ...
                initPWA() {
                    if (this.isIOS && !this.isStandalone) {
                        this.canInstall = true;
                    }
                    window.addEventListener('beforeinstallprompt', (e) => {
                        e.preventDefault();
                        this.installPrompt = e;
                        this.canInstall = true;
                    });
                },

                async installApp() {
                    if (this.installPrompt) {
                        this.installPrompt.prompt();
                        const { outcome } = await this.installPrompt.userChoice;
                        if (outcome === 'accepted') this.canInstall = false;
                        this.installPrompt = null;
                    } else if (this.isIOS) {
                        alert("To install: Tap the Share button below ‚Ü• and select 'Add to Home Screen' +");
                    }
                },
                
                initHaptics() {
                    // Initialize Web Audio API for iOS Haptic fallback
                    if (!this.hapticCtx) {
                        const AudioContext = window.AudioContext || window.webkitAudioContext;
                        if (AudioContext) {
                            this.hapticCtx = new AudioContext();
                            // Play silent buffer to unlock audio engine on iOS
                            const buffer = this.hapticCtx.createBuffer(1, 1, 22050);
                            const source = this.hapticCtx.createBufferSource();
                            source.buffer = buffer;
                            source.connect(this.hapticCtx.destination);
                            source.start(0);
                        }
                    }
                },

                login() {
                    this.initHaptics(); // Unlock audio context on first user gesture
                    const btn = document.querySelector('button');
                    btn.classList.add('scale-95', 'opacity-90');
                    setTimeout(() => {
                        this.user = { name: "Mindful User" };
                        this.view = 'home';
                    }, 800);
                },

                selectTea(moodItem) {
                    this.vibrate(10);
                    setTimeout(() => {
                        this.selectedMood = moodItem;
                        this.selectedTea = this.teas[moodItem.id];
                        this.initialTime = this.selectedTea.duration;
                        this.timer = this.initialTime;
                        this.view = 'result';
                        this.breathPhase = 'Prepare';
                        this.breathState = 'ready';
                        this.showDetails = false;
                        this.zenWisdom = ''; // Reset AI wisdom
                    }, 150);
                },

                startQuickCalm() {
                    this.vibrate(10);
                    setTimeout(() => {
                        this.selectedMood = { label: 'Quick Calm' };
                        this.selectedTea = { 
                            name: "Deep Breathing", 
                            benefit: "Restores Balance", 
                            duration: 60,
                            science: "Deep rhythmic breathing stimulates the vagus nerve, activating the parasympathetic nervous system to lower heart rate and blood pressure.",
                            tips: "Inhale through your nose, expanding your belly. Exhale slowly through pursed lips."
                        };
                        this.initialTime = 60;
                        this.timer = 60;
                        this.view = 'result';
                        this.breathPhase = 'Prepare';
                        this.breathState = 'ready';
                        this.showDetails = false;
                        this.zenWisdom = '';
                    }, 150);
                },

                // --- AUDIO LOGIC ---
                toggleAmbience() {
                    if (this.audioState === 'off') {
                        this.audioState = 'rain';
                        this.playAudio(this.audioTracks.rain);
                    } else if (this.audioState === 'rain') {
                        this.audioState = 'forest';
                        this.playAudio(this.audioTracks.forest);
                    } else {
                        this.audioState = 'off';
                        this.audioPlayer.pause();
                    }
                    this.vibrate(10);
                },

                playAudio(src) {
                    this.audioPlayer.src = src;
                    this.audioPlayer.volume = 0;
                    
                    const playPromise = this.audioPlayer.play();
                    
                    if (playPromise !== undefined) {
                        playPromise.then(_ => {
                            // Fade in
                            let vol = 0;
                            const fade = setInterval(() => {
                                if (vol < 0.5) {
                                    vol += 0.05;
                                    this.audioPlayer.volume = vol;
                                } else {
                                    clearInterval(fade);
                                }
                            }, 200);
                        })
                        .catch(error => {
                            console.error("Audio playback error:", error);
                            // Reset state if playback fails (e.g. interaction policy or network error)
                            this.audioState = 'off';
                        });
                    }
                },

                // --- AI LOGIC (GROQ) ---
                async getZenWisdom() {
                    this.aiLoading = true;
                    this.vibrate(20);
                    
                    const mood = this.selectedMood.label;
                    const tea = this.selectedTea.name;
                    
                    try {
                        const response = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                            method: "POST",
                            headers: {
                                "Authorization": `Bearer ${this.apiKey}`,
                                "Content-Type": "application/json"
                            },
                            body: JSON.stringify({
                                messages: [
                                    {
                                        role: "user",
                                        content: `Generate a very short, poetic, 1-sentence meditation intention or zen wisdom for someone drinking ${tea} and feeling ${mood}. Do not use quotes.`
                                    }
                                ],
                                model: "llama3-8b-8192",
                                temperature: 0.7,
                                max_tokens: 60
                            })
                        });

                        const data = await response.json();
                        if (data.choices && data.choices.length > 0) {
                            this.zenWisdom = data.choices[0].message.content.trim();
                        } else {
                            this.zenWisdom = "Breathe deeply, and let the moment unfold naturally.";
                        }
                    } catch (error) {
                        console.error("AI Error:", error);
                        this.zenWisdom = "The present moment is the only moment that exists.";
                    } finally {
                        this.aiLoading = false;
                        this.vibrate([10, 50, 10]);
                    }
                },

                // --- SHARE EXPERIENCE LOGIC ---
                async shareExperience() {
                    this.vibrate(20);
                    
                    // Default Text
                    const mood = this.selectedMood ? this.selectedMood.label : 'Peace';
                    const text = `I'm finding my ${mood} moment with Mindful Brew. Join me in a daily ritual of calm. üçµ‚ú®`;
                    
                    const shareData = {
                        title: 'Mindful Brew',
                        text: text,
                        url: 'https://mindfulbrew.space'
                    };

                    if (navigator.share && navigator.canShare(shareData)) {
                        try {
                            await navigator.share(shareData);
                        } catch (err) {
                            console.log('Share canceled or failed', err);
                        }
                    } else {
                        // Fallback: Copy to clipboard
                        navigator.clipboard.writeText(`${text} https://mindfulbrew.space`).then(() => {
                            alert('Link copied to clipboard! Share it with your friends.');
                        }).catch(err => {
                            console.error('Failed to copy', err);
                        });
                    }
                },

                // --- JOURNAL LOGIC ---
                openJournalModal(options = {}) {
                    if (options.fromSession && this.selectedTea) {
                        this.journalForm.tea = this.selectedTea.name;
                        this.journalForm.mood = this.selectedMood ? this.selectedMood.id : 'stressed';
                        this.journalForm.notes = this.zenWisdom || '';
                    } else {
                        // Reset or Default
                        this.journalForm.tea = Object.values(this.teas)[0].name;
                        this.journalForm.mood = this.moods[0].id;
                        this.journalForm.rating = 5;
                        this.journalForm.notes = '';
                    }
                    this.showJournalModal = true;
                },

                saveJournalEntry() {
                    const newEntry = {
                        id: Date.now(),
                        date: new Date().toISOString(),
                        ...this.journalForm
                    };
                    this.journalEntries.unshift(newEntry);
                    this.saveToStorage();
                    this.showJournalModal = false;
                    this.vibrate(20);
                    
                    // If we were in result view, go to journal tab
                    if (this.view === 'result') {
                         this.reset(); // Stop timer, etc.
                         this.view = 'home'; // Go to main layout
                         setTimeout(() => { this.activeTab = 'journal'; }, 100);
                    }
                },

                deleteJournalEntry(id) {
                    if(confirm("Delete this entry?")) {
                        this.journalEntries = this.journalEntries.filter(e => e.id !== id);
                        this.saveToStorage();
                    }
                },

                saveToStorage() {
                    localStorage.setItem('mindfulJournal', JSON.stringify(this.journalEntries));
                },

                formatDate(isoString) {
                    return new Date(isoString).toLocaleDateString('en-US', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
                },

                getMoodIcon(moodId) {
                    const m = this.moods.find(x => x.id === moodId);
                    return m ? m.icon : '‚ú®';
                },

                toggleHaptics() {
                    this.hapticsEnabled = !this.hapticsEnabled;
                    if (this.hapticsEnabled) this.vibrate([30, 50, 30]);
                },

                vibrate(pattern) {
                    if (!this.hapticsEnabled) return;

                    // Standard Vibration API (Android)
                    if (navigator.vibrate) {
                        // navigator.vibrate checks for hardware support, but on some iOS versions it might exist but do nothing.
                        // Ideally we detect iOS explicitly for the fallback if we want to force sound.
                        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
                        if (!isIOS) {
                             navigator.vibrate(pattern);
                             return;
                        }
                    }

                    // iOS / Fallback via Audio
                    if (this.hapticCtx) {
                        if (this.hapticCtx.state === 'suspended') this.hapticCtx.resume();

                        const trigger = () => {
                            const osc = this.hapticCtx.createOscillator();
                            const gain = this.hapticCtx.createGain();
                            osc.connect(gain);
                            gain.connect(this.hapticCtx.destination);
                            
                            // Deep "thud" sound mimicking Taptic Engine
                            osc.type = 'sine';
                            osc.frequency.setValueAtTime(50, this.hapticCtx.currentTime);
                            
                            gain.gain.setValueAtTime(0.5, this.hapticCtx.currentTime); // Moderate volume
                            gain.gain.exponentialRampToValueAtTime(0.01, this.hapticCtx.currentTime + 0.05);

                            osc.start(this.hapticCtx.currentTime);
                            osc.stop(this.hapticCtx.currentTime + 0.05);
                        };

                        if (Array.isArray(pattern)) {
                            let delay = 0;
                            pattern.forEach((val, i) => {
                                if (i % 2 === 0) {
                                    setTimeout(trigger, delay);
                                }
                                delay += val;
                            });
                        } else {
                            trigger();
                        }
                    }
                },

                toggleTimer() {
                    this.vibrate(10);
                    if (this.timerRunning) {
                        this.pauseTimer();
                    } else {
                        this.startTimer();
                    }
                },

                startTimer() {
                    if (this.timer <= 0) return;
                    this.timerRunning = true;
                    this.cycleCounter = 0;
                    this.breathPhase = 'Inhale';
                    this.breathState = 'inhale';
                    this.vibrate(20);
                    
                    this.interval = setInterval(() => {
                        if (this.timer > 0) {
                            this.timer--;
                            this.cycleCounter++;
                            // Cycle logic: Inhale (4s) -> Hold (3s) -> Exhale (5s) = 12s cycle
                            const t = this.cycleCounter % 12;
                            
                            if (t === 0) { 
                                this.breathPhase = 'Inhale';
                                this.breathState = 'inhale';
                                this.vibrate(40);
                            } else if (t === 4) {
                                this.breathPhase = 'Hold';
                                this.breathState = 'hold';
                                this.vibrate(20);
                            } else if (t === 7) {
                                this.breathPhase = 'Exhale';
                                this.breathState = 'exhale';
                                this.vibrate(40);
                            }
                            
                        } else {
                            this.pauseTimer();
                            this.breathPhase = 'Ready';
                            this.breathState = 'ready';
                            this.timer = 0;
                            this.vibrate([100, 50, 100]); 
                        }
                    }, 1000);
                },

                pauseTimer() {
                    this.timerRunning = false;
                    clearInterval(this.interval);
                },

                resetTimer() {
                    this.vibrate(10);
                    this.pauseTimer();
                    this.timer = this.initialTime;
                    this.breathPhase = 'Ready';
                    this.breathState = 'ready';
                },

                reset() {
                    this.pauseTimer();
                    this.view = 'home';
                    this.audioState = 'off';
                    this.audioPlayer.pause();
                    setTimeout(() => {
                        this.selectedMood = null;
                        this.selectedTea = null;
                        this.timer = 0;
                        this.zenWisdom = '';
                    }, 500);
                },

                get formattedTime() {
                    const m = Math.floor(this.timer / 60);
                    const s = this.timer % 60;
                    return `${m}:${s < 10 ? '0' + s : s}`;
                },

                get strokeDashoffset() {
                    if (this.initialTime === 0) return 0;
                    const percentage = this.timer / this.initialTime;
                    return this.circumference * (1 - percentage);
                }
            }
        }
    </script>
</body>
</html>
